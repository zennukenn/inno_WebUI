# Inno WebUI è°ƒè¯•ç‰ˆæœ¬ Dockerfile
# ç”¨äºè°ƒè¯•å‰ç«¯æ„å»ºé—®é¢˜

# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºå‰ç«¯
FROM node:18-alpine AS frontend-builder

WORKDIR /app/frontend

# å¤åˆ¶å‰ç«¯ä¾èµ–æ–‡ä»¶
COPY frontend/package*.json ./

# å®‰è£…å‰ç«¯ä¾èµ–
RUN npm ci

# å¤åˆ¶å‰ç«¯æºä»£ç 
COPY frontend/ ./

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VITE_API_BASE_URL=/api

# è°ƒè¯•ï¼šæ˜¾ç¤ºæ–‡ä»¶ç»“æ„
RUN echo "ğŸ“ Frontend source structure:" && \
    ls -la && \
    echo "ğŸ“„ Package.json scripts:" && \
    cat package.json | grep -A 10 '"scripts"'

# æ„å»ºå‰ç«¯åº”ç”¨
RUN echo "ğŸš€ Running frontend build..." && \
    npm run build && \
    echo "âœ… Frontend build completed"

# è°ƒè¯•ï¼šæ£€æŸ¥æ„å»ºäº§ç‰©
RUN echo "ğŸ“¦ Checking build output..." && \
    ls -la && \
    echo "ğŸ“ Build directory:" && \
    (ls -la build/ && echo "âœ… build/ found") || echo "âŒ build/ not found" && \
    echo "ğŸ“ Dist directory:" && \
    (ls -la dist/ && echo "âœ… dist/ found") || echo "âŒ dist/ not found" && \
    echo "ğŸ“ SvelteKit output:" && \
    (ls -la .svelte-kit/output/ && echo "âœ… .svelte-kit/output/ found") || echo "âŒ .svelte-kit/output/ not found"

# åˆ›å»ºç»Ÿä¸€çš„é™æ€æ–‡ä»¶ç›®å½•
RUN mkdir -p /static && \
    if [ -d "build" ]; then \
        echo "ğŸ“¦ Copying from build/"; \
        cp -r build/* /static/; \
    elif [ -d "dist" ]; then \
        echo "ğŸ“¦ Copying from dist/"; \
        cp -r dist/* /static/; \
    elif [ -d ".svelte-kit/output/client" ]; then \
        echo "ğŸ“¦ Copying from .svelte-kit/output/client/"; \
        cp -r .svelte-kit/output/client/* /static/; \
    else \
        echo "âŒ No build output found, creating fallback"; \
        echo '<!DOCTYPE html><html><head><title>Inno WebUI</title></head><body><h1>Inno WebUI</h1><p>Build output not found</p></body></html>' > /static/index.html; \
    fi && \
    echo "ğŸ“ Final static content:" && \
    ls -la /static/

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œç¯å¢ƒ
FROM python:3.11-slim AS production

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    curl \
    nginx \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶åç«¯ä¾èµ–æ–‡ä»¶
COPY backend/requirements.txt ./

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åç«¯ä»£ç 
COPY backend/ ./

# ä»å‰ç«¯æ„å»ºé˜¶æ®µå¤åˆ¶é™æ€æ–‡ä»¶
COPY --from=frontend-builder /static ./static

# éªŒè¯é™æ€æ–‡ä»¶
RUN echo "ğŸ“ Checking copied static files:" && \
    ls -la /app/static/ && \
    echo "ğŸ“„ Checking for index.html:" && \
    (cat /app/static/index.html | head -5 || echo "âš ï¸ index.html not found or empty")

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/data /app/logs /var/log/supervisor

# é…ç½®Nginx
RUN rm -f /etc/nginx/sites-enabled/default
COPY docker/nginx-single.conf /etc/nginx/sites-available/default
RUN ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/

# é…ç½®Supervisor
COPY docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY docker/start-services.sh /usr/local/bin/start-services.sh
RUN chmod +x /usr/local/bin/start-services.sh

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV HOST=0.0.0.0
ENV PORT=8080
ENV NODE_ENV=production

# æš´éœ²ç«¯å£
EXPOSE 80 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:80/health || exit 1

# å¯åŠ¨æœåŠ¡
CMD ["/usr/local/bin/start-services.sh"]
